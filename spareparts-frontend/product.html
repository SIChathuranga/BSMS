<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Details | BSMS</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Custom Styles -->
  <link href="css/styles.css" rel="stylesheet">
</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="bi bi-speedometer2"></i>
        BSMS
      </a>

      <div class="d-flex align-items-center gap-2">
        <button id="themeToggle" class="theme-toggle">
          <i class="bi bi-moon-fill"></i>
        </button>
        <a href="index.html#products" class="btn btn-outline-primary">
          <i class="bi bi-arrow-left me-1"></i>Back
        </a>
      </div>
    </div>
  </nav>

  <!-- Product Details -->
  <div class="container py-5">
    <div id="loadingState" class="text-center py-5">
      <div class="loading-spinner mx-auto mb-3"></div>
      <p class="text-muted">Loading product details...</p>
    </div>

    <div id="productContent" class="d-none">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="index.html">Home</a></li>
          <li class="breadcrumb-item"><a href="index.html#products">Products</a></li>
          <li class="breadcrumb-item active" aria-current="page" id="breadcrumbName">Product</li>
        </ol>
      </nav>

      <div class="row g-5">
        <!-- Product Images -->
        <div class="col-lg-6">
          <div class="product-image-gallery">
            <div class="main-image mb-3 rounded-xl overflow-hidden shadow-md">
              <img id="mainImage" src="" alt="Product" class="img-fluid w-100"
                style="max-height: 500px; object-fit: cover;">
            </div>
            <div class="thumbnail-grid d-flex gap-2 overflow-auto" id="thumbnailGrid">
              <!-- Thumbnails inserted via JS -->
            </div>
          </div>
        </div>

        <!-- Product Info -->
        <div class="col-lg-6">
          <div class="product-info">
            <span class="badge bg-primary mb-2" id="productCategory">Category</span>
            <h1 class="display-5 fw-bold mb-3" id="productName">Product Name</h1>

            <div class="d-flex align-items-center gap-3 mb-4">
              <div class="d-flex align-items-center text-warning">
                <i class="bi bi-star-fill"></i>
                <span class="ms-1 fw-bold" id="productRating">4.5</span>
              </div>
              <span class="text-muted">|</span>
              <span class="text-muted" id="productReviews">0 Reviews</span>
              <span class="text-muted">|</span>
              <span id="productStock">In Stock</span>
            </div>

            <div class="mb-4">
              <span class="display-6 fw-bold text-primary" id="productPrice">$99.99</span>
            </div>

            <p class="lead text-secondary mb-4" id="productDescription">
              Product description goes here.
            </p>

            <div class="features-list mb-4">
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-check-circle-fill text-success"></i>
                <span id="productBrand">Brand: Honda</span>
              </div>
              <div class="d-flex align-items-center gap-2 mb-2">
                <i class="bi bi-shield-check-fill text-success"></i>
                <span>Genuine Part</span>
              </div>
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-truck text-success"></i>
                <span>Fast Shipping Available</span>
              </div>
            </div>

            <!-- Actions -->
            <div class="d-flex gap-3 mb-5">
              <div class="input-group" style="width: 140px;">
                <button class="btn btn-outline-secondary" type="button" onclick="decrementQty()">-</button>
                <input type="number" class="form-control text-center" id="qtyInput" value="1" min="1">
                <button class="btn btn-outline-secondary" type="button" onclick="incrementQty()">+</button>
              </div>
              <button class="btn btn-primary flex-grow-1 btn-lg" id="addToCartBtn">
                <i class="bi bi-cart-plus me-2"></i>Add to Cart
              </button>
              <button class="btn btn-outline-danger btn-lg btn-icon" id="wishlistBtn">
                <i class="bi bi-heart"></i>
              </button>
            </div>

            <!-- Compatibility -->
            <div class="card mb-4">
              <div class="card-header bg-transparent fw-bold">
                <i class="bi bi-info-circle me-2"></i>Compatible Models
              </div>
              <div class="card-body">
                <div class="d-flex flex-wrap gap-2" id="compatibleModels">
                  <!-- Models inserted via JS -->
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="mt-5 pt-5 border-top">
        <h3 class="mb-4">Customer Reviews</h3>
        <div id="reviewsList">
          <!-- Reviews inserted via JS -->
          <p class="text-muted">No reviews yet.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module">
    import { API_BASE_URL, authorizedFetch } from './js/app.js';

    const urlParams = new URLSearchParams(window.location.search);
    const productId = urlParams.get('id');

    if (!productId) {
      window.location.href = 'index.html';
    }

    let currentProduct = null;

    async function loadProduct() {
      try {
        const response = await fetch(`${'http://localhost:8080/api/v2'}/public/products/${productId}`);
        if (!response.ok) throw new Error('Product not found');

        const product = await response.json();
        currentProduct = product;
        renderProduct(product);

        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('productContent').classList.remove('d-none');

        // Load reviews
        loadReviews(productId);

        // Check wishlist
        updateWishlistBtn();

      } catch (error) {
        document.getElementById('loadingState').innerHTML = `
        <div class="text-danger mb-3"><i class="bi bi-exclamation-circle h1"></i></div>
        <h3>Product Not Found</h3>
        <a href="index.html" class="btn btn-primary mt-3">Back to Store</a>
      `;
      }
    }

    async function loadReviews(productId) {
      try {
        const response = await fetch(`${'http://localhost:8080/api/v2'}/public/products/${productId}/reviews`);
        const reviews = await response.json();

        const container = document.getElementById('reviewsList');
        if (reviews.length === 0) {
          container.innerHTML = '<p class="text-muted">No reviews yet. Be the first to review!</p>';
          return;
        }

        container.innerHTML = reviews.map(review => `
        <div class="card mb-3 border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between mb-2">
              <h6 class="fw-bold mb-0">${review.userName || 'Anonymous'}</h6>
              <small class="text-muted">${new Date(review.createdAt).toLocaleDateString()}</small>
            </div>
            <div class="text-warning mb-2">
              ${'★'.repeat(review.rating)}${'☆'.repeat(5 - review.rating)}
            </div>
            <p class="card-text text-secondary">${review.comment}</p>
          </div>
        </div>
      `).join('');

      } catch (error) {
        console.warn('Failed to load reviews', error);
      }
    }

    function renderProduct(product) {
      document.title = `${product.name} | BSMS`;
      document.getElementById('breadcrumbName').textContent = product.name;
      document.getElementById('productCategory').textContent = product.category || 'General';
      document.getElementById('productName').textContent = product.name;
      document.getElementById('productRating').textContent = product.averageRating?.toFixed(1) || '0.0';
      document.getElementById('productReviews').textContent = `${product.reviewCount || 0} Reviews`;
      document.getElementById('productPrice').textContent = `$${product.price?.toFixed(2)}`;
      document.getElementById('productDescription').textContent = product.description;
      document.getElementById('productBrand').textContent = `Brand: ${product.brand || 'Universal'}`;

      // Stock status
      const stockEl = document.getElementById('productStock');
      if (product.stock > 10) {
        stockEl.innerHTML = '<span class="text-success"><i class="bi bi-check-circle-fill"></i> In Stock</span>';
      } else if (product.stock > 0) {
        stockEl.innerHTML = '<span class="text-warning"><i class="bi bi-exclamation-triangle-fill"></i> Low Stock</span>';
      } else {
        stockEl.innerHTML = '<span class="text-danger"><i class="bi bi-x-circle-fill"></i> Out of Stock</span>';
        document.getElementById('addToCartBtn').disabled = true;
        document.getElementById('addToCartBtn').textContent = 'Out of Stock';
      }

      // Images
      const mainImg = product.images?.[0] || 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=800';
      document.getElementById('mainImage').src = mainImg;

      if (product.images?.length > 1) {
        const grid = document.getElementById('thumbnailGrid');
        grid.innerHTML = product.images.map(img => `
        <img src="${img}" class="rounded cursor-pointer border" width="80" height="80" 
             style="object-fit: cover;" onclick="document.getElementById('mainImage').src='${img}'">
      `).join('');
      }

      // Models
      const modelsDiv = document.getElementById('compatibleModels');
      if (product.compatibleModels?.length > 0) {
        modelsDiv.innerHTML = product.compatibleModels.map(m =>
          `<span class="badge bg-secondary">${m}</span>`
        ).join('');
      } else {
        modelsDiv.innerHTML = '<span class="text-muted">Universal Fit / Check description</span>';
      }
    }

    // Qty handlers
    window.incrementQty = () => {
      const input = document.getElementById('qtyInput');
      input.value = parseInt(input.value) + 1;
    };

    window.decrementQty = () => {
      const input = document.getElementById('qtyInput');
      if (parseInt(input.value) > 1) {
        input.value = parseInt(input.value) - 1;
      }
    };

    // Add to Cart
    document.getElementById('addToCartBtn').addEventListener('click', () => {
      const qty = parseInt(document.getElementById('qtyInput').value);

      // Get cart from storage
      let cart = JSON.parse(localStorage.getItem('bsms_cart') || '[]');
      const existing = cart.find(i => String(i.id) === String(currentProduct.id));

      if (existing) {
        existing.quantity += qty;
      } else {
        cart.push({
          id: currentProduct.id,
          name: currentProduct.name,
          price: currentProduct.price,
          image: currentProduct.images?.[0] || '',
          quantity: qty
        });
      }

      localStorage.setItem('bsms_cart', JSON.stringify(cart));

      // Simple toast
      const btn = document.getElementById('addToCartBtn');
      const original = btn.innerHTML;
      btn.classList.replace('btn-primary', 'btn-success');
      btn.innerHTML = '<i class="bi bi-check2"></i> Added to Cart';

      setTimeout(() => {
        btn.classList.replace('btn-success', 'btn-primary');
        btn.innerHTML = original;
      }, 2000);
    });

    // Wishlist
    function updateWishlistBtn() {
      const wishlist = JSON.parse(localStorage.getItem('bsms_wishlist') || '[]');
      const btn = document.getElementById('wishlistBtn');
      const isWishlisted = wishlist.includes(String(productId));

      if (isWishlisted) {
        btn.classList.add('active', 'btn-danger');
        btn.classList.remove('btn-outline-danger');
        btn.innerHTML = '<i class="bi bi-heart-fill"></i>';
      } else {
        btn.classList.remove('active', 'btn-danger');
        btn.classList.add('btn-outline-danger');
        btn.innerHTML = '<i class="bi bi-heart"></i>';
      }
    }

    document.getElementById('wishlistBtn').addEventListener('click', () => {
      let wishlist = JSON.parse(localStorage.getItem('bsms_wishlist') || '[]');
      const pId = String(productId);

      if (wishlist.includes(pId)) {
        wishlist = wishlist.filter(id => id !== pId);
      } else {
        wishlist.push(pId);
      }

      localStorage.setItem('bsms_wishlist', JSON.stringify(wishlist));
      updateWishlistBtn();
    });

    // Init
    loadProduct();

    // Theme
    const themeToggle = document.getElementById('themeToggle');
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    themeToggle.onclick = () => {
      const current = document.documentElement.getAttribute('data-theme');
      const newTheme = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    };
  </script>

</body>

</html>